pool:
  vmImage: 'ubuntu-latest'  # El agente que usará Azure DevOps (puedes cambiarlo por otro si lo prefieres)

variables:
  azureSubscription: 'AzureConnection-Holocron'  # Nombre de tu suscripción de Azure
  acrName: 'ContainerConnectionRegistry'  # Nombre de tu Azure Container Registry
  imageName: 'holocron-api'  # Nombre de la imagen que se creará
  containerAppName: 'holocron-backend'  # Nombre de la aplicación de contenedor que será desplegada
  imageTag: '$(Build.BuildId)'  # Etiqueta única para cada construcción (ID de compilación)
  dockerfilePath: './Holocron.API/Dockerfile'  # Ruta del archivo Dockerfile en tu repositorio

stages:
- stage: Build
  displayName: 'Build Docker Image'
  jobs:
  - job: BuildAndPush
    displayName: 'Build and Push Docker Image to ACR'
    steps:
    - task: Docker@2
      displayName: 'Log in to Azure Container Registry'
      inputs:
        containerRegistry: 'holocronregistry'  # El nombre de la conexión de servicio tipo Docker Registry creada
        repository: 'holocronregistry.azurecr.io/$(imageName)'  # Repositorio en ACR (usamos la URL del ACR)
        command: 'login'  # El task Docker@2 maneja el login automáticamente
        
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        containerRegistry: 'holocronregistry'  # Conexión de servicio a tu ACR
        repository: 'holocronregistry.azurecr.io/$(imageName)'  # Nombre del repositorio en ACR
        dockerfile: $(dockerfilePath)
        buildContext: $(Build.SourcesDirectory)  # Directorio del código fuente
        tags: $(imageTag)  # Usamos el ID de la compilación como tag de la imagen

    - task: Docker@2
      displayName: 'Push Docker Image to ACR'
      inputs:
        containerRegistry: 'holocronregistry'  # Conexión de servicio a tu ACR
        repository: 'holocronregistry.azurecr.io/$(imageName)'  # Nombre del repositorio en ACR
        command: 'push'
        tags: $(imageTag)  # Subimos la imagen al ACR con el tag

- stage: Deploy
  displayName: 'Deploy to Azure Container Apps'
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: 'Deploy to Azure Container Apps'
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy to Azure Container Apps'
      inputs:
        azureSubscription: $(azureSubscription)  # Suscripción de Azure configurada en Azure DevOps
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az containerapp up \
            --name $(containerAppName) \
            --resource-group lsanwebapp01_group  # Grupo de recursos en Azure
            --image $(acrName).azurecr.io/$(imageName):$(imageTag) \
            --target-port 80  # Puerto al que expondrás el contenedor
            --env-vars CONNECTION_STRING=$(YOUR_CONNECTION_STRING)  # Variables de entorno que necesita tu aplicación
            --cpu 1 --memory 2Gi  # Configura los recursos de la aplicación (puedes ajustarlo)